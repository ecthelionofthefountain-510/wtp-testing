name: API Tests with Newman

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  api_tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Newman
        run: npm install -g newman

      - name: Restore backend dependencies
        run: dotnet restore ./WTP-main/server/server.csproj

      - name: Start backend
        run: dotnet run --project ./WTP-main/server/server.csproj &
      
      - name: V칛nta p친 backend
        run: sleep 20

      - name: Kontrollera att backend k칬rs
        run: |
          echo "游댃 Kollar om backend svarar..."
          curl -v http://localhost:5000/api/health || echo "Health endpoint svarar inte, vi g친r 칛nd친 vidare."
          echo "游댏 Testar login..."
          curl -v -X POST http://localhost:5000/api/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin@admin.com","password":"admin321"}' || echo "Login svarar inte, vi g친r 칛nd친 vidare."

      - name: K칬r Postman-tester
        run: |
          echo "游늬 Inneh친ll i postman/:"
          ls -la postman/

          newman run postman/WTP.postman_collection.json \
            -e postman/WTP_environment.postman_environment.json \
            --insecure \
            --reporters cli,json \
            --reporter-json-export newman-results.json \
            --export-cookie-jar newman_cookies.json \
            --verbose

  gui_tests:
    runs-on: ubuntu-latest
    needs: api_tests

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore E2E dependencies
        run: dotnet restore ./E2ETesting-main/E2ETesting.csproj

      - name: Build E2E Test Project
        run: dotnet build ./E2ETesting-main/E2ETesting.csproj

      - name: Install Playwright Browsers
        run: pwsh ./E2ETesting-main/bin/Debug/net8.0/playwright.ps1 install --with-deps

      - name: Run Playwright Tests
        run: dotnet test ./E2ETesting-main/E2ETesting.csproj